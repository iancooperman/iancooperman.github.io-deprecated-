!function(e){e.crossposting={crosspostableSubreddits:[],init:function(){this.popup=new e.ui.Popup({size:"xlarge",content:$("#crosspost-popup").html(),className:"crossposting-modal"})},bindClick:function(){$(".post-crosspost-button").on("click",this.handleClick.bind(this))},handleClick:function(t){this.init(),$(".crossposting-modal").remove(),this.dropdown=this.createSubredditDropdown(),this.createPostPreview($(t.target).thing()[0]),this.updateDataAndLinks($(t.target)),this.findEl(".crosspost-sr-dropdown select").append(this.dropdown),this.onSelectSubreddit(),e.config.feature_crossposting_recent&&(this.recentList=this.createRecentList(),!this.recentList||(this.findEl(".crosspost-recent-sr").show(),this.findEl(".crosspost-recent-sr-list").append(this.recentList).delegate("a","click",this.onRecentSRClick.bind(this)))),this.popup.show(),e.flatlistevent.sendFlatListEvent(t,"post_flatlist_crosspost_click");var n=new e.ui.Recaptcha({el:this.findEl(".crosspost-tab-content__form")[0],location:"submit"});n.loadCaptcha(),this.findEl("input").on("input",this.onFieldUpdate.bind(this)),this.findEl("select").on("change",this.onSelectSubreddit.bind(this))},findEl:function(e){return this.popup.$.find(e)},onRecentSRClick:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.attr("href");this.findEl("select").val(n).change()},createPostPreview:function(e){var t=$(e.innerHTML),n=$(e.outerHTML),r=this.findEl(".crosspost-preview"),i=n.find(".thumbnail img")[0],s=n.data("crosspost-root-title")||t.find("a.title").text(),o=_.template("<% if (thumbnail) { %><div class='crosspost-thumbnail'><%= thumbnail %></div><% } %><div><div class='crosspost-post-title'><%= title %></div><div class='crosspost-post-tagline'><%= score %> points â€¢ <%= commentsCount %> comments</div><div class='crosspost-post-tagline'>submitted <%= time %> by <%= author %> into r/<%= subredditNamePrefixed %></div>"),u=this.findEl("input.crosspost-title");u.val(s),this.findEl(".crosspost-title-fake").text(s).on("keypress",function(e){return e.which!=13}).on("keyup",function(e){u.val($(this).text())}),r.html(o({score:n.data("crosspost-root-score")||e.dataset.score,commentsCount:n.data("crosspost-root-num-comments")||e.dataset.commentsCount,title:n.data("crosspost-root-title")||t.find("a.title").text(),time:n.data("crosspost-root-time")||t.find(".tagline time").text(),author:n.data("crosspost-root-author")||e.dataset.author,thumbnail:i?i.outerHTML:!1,subredditNamePrefixed:n.data("crosspost-root-subreddit")||e.dataset.subreddit}))},onFieldUpdate:function(){var e=$(".crosspost-button"),t=$("input.crosspost-title"),n=$(".crosspost-subreddit");t.val()&&n.val()?e.removeAttr("disabled"):e.attr("disabled","disabled")},onSelectSubreddit:function(t){var n=this.findEl(".crosspost-subreddit").val(),i="<div class='crosspost-label'>Crossposting rules</div>",s=this.findEl(".crosspost-subreddit-rules");e.ajax({async:!1,type:"GET",url:"/r/"+n+"/about/rules.json"}).then(function(e){function o(e){var t="";return e.forEach(function(e){t+="<li>"+e.short_name+"</li>"}),"<ul class='crosspost-subreddit-rules-list'>"+t+"</ul>"}var t=e.rules.filter(function(e){return e.kind==="link"||e.kind==="all"}),r=t.length;i+=o(t.slice(0,Math.min(r,5))),r>5&&(i+=o(t.slice(5,Math.min(r,10)))),i+="<div class='clearleft'></div>",i+="<a class='crosspost-link' target='_blank' href='/r/"+n+"/about/rules'>See rules details</a>",r!==0?s.html(i):s.html("")})},createSubredditDropdown:function(){var t="";return e.ajax({async:!1,type:"GET",url:"/api/crosspostable_subreddits.json"}).then(function(n){n&&("u_"+e.config.logged===n[0]&&(t+="<option value="+n[0]+">Your Profile</option>",n.shift()),this.crosspostableSubreddits=n,n.map(function(e){t+="<option value="+e+">"+e+"</option>"}))}.bind(this)),t},createRecentList:function(){var t="";return e.ajax({async:!1,type:"GET",url:"/user/"+e.config.logged+"/top_karma_subreddits.json"}).then(function(e){if(e&&e.data&&e.data.length){var n=e.data.filter(function(e){return this.crosspostableSubreddits.indexOf(e.sr)!==-1}.bind(this));n.map(function(e){t+='<a href="'+e.sr+'">'+e.sr+"</a>"})}}.bind(this)),t},updateDataAndLinks:function(e){var t=e.thing_id(),n=this.findEl("#crosspost_fullname");n.val(t);var r=$(e.thing()[0].outerHTML),i=r.data("num-crossposts"),s=r.data("permalink").replace("/comments/","/duplicates/");i=i?parseInt(i):0,i&&this.findEl(".crosspost-link").attr("href",s).show()}},$(function(){e.config.logged&&e.crossposting.bindClick()})}(r);